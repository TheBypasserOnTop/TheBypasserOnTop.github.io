<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Settings</title>
<link rel="icon" href="favicon.ico">

<style>
body {
  margin:0;
  min-height:100vh;
  background:radial-gradient(circle at top,#0b1e3d,#050b1a);
  font-family:system-ui,sans-serif;
  color:#e6f0ff;
  overflow-x:hidden;
}
.card {
  width:90%;
  max-width:400px;
  padding:25px;
  background:rgba(12,25,55,.65);
  backdrop-filter:blur(16px);
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.4);
  text-align:center;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
}
#profilePic {
  position:fixed;
  top:15px;
  right:15px;
  width:50px;
  height:50px;
  border-radius:50%;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  font-size:1.3rem;
  cursor:pointer;
  color:white;
  user-select:none;
  z-index:100;
  background-size:cover;
}
#profilePanel {
  position:fixed;
  top:75px;
  right:15px;
  width:180px;
  background:rgba(12,25,55,.85);
  backdrop-filter:blur(12px);
  border-radius:14px;
  display:none;
  flex-direction:column;
  padding:10px;
  z-index:100;
}
#profilePanel .accountName {
  font-weight:bold;
  padding:5px 0;
  text-align:center;
  border-bottom:1px solid rgba(255,255,255,.2);
  margin-bottom:5px;
}
#profilePanel button {
  margin:5px 0;
  padding:8px;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}
.section {
  background:rgba(0,0,0,.25);
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
  text-align:left;
}
#pfpPreview {
  width:50px;
  height:50px;
  border-radius:50%;
  display:inline-flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  font-size:1.2rem;
  color:white;
  cursor:pointer;
  margin-left:10px;
  background-size:cover;
}
#pfpPanel {
  display:none;
  position:absolute;
  background:rgba(12,25,55,0.85);
  backdrop-filter:blur(12px);
  padding:8px;
  border-radius:10px;
  flex-direction:column;
  top:80px;
  right:80px;
  width:120px;
  z-index:15;
}
.overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  backdrop-filter:blur(6px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:20;
}
.popup {
  width:90vw;
  max-width:400px;
  background:#0c1937;
  padding:30px;
  border-radius:20px;
  text-align:center;
}
.close { float:right; cursor:pointer; }
.error { color:#ff4c4c; min-height:1.2em; margin-top:10px; }
</style>
</head>

<body>

<div id="profilePic"></div>

<div id="profilePanel">
  <div class="accountName" id="panelUsername"></div>
  <button id="dashboardBtn">Dashboard</button>
  <button id="logoutBtn">Logout</button>
</div>

<div class="card">
  <h2>Settings</h2>

  <div class="section">
    <h3>Account Settings</h3>

    Profile Picture:
    <div id="pfpPreview"></div>
    <div id="pfpPanel">
      <button id="changePfpBtn">Change</button>
      <button id="removePfpBtn">Remove</button>
      <button id="viewPfpBtn">View</button>
    </div>

    <div>
      Username: <span id="usernameDisplay"></span>
      <button id="changeUsernameBtn">Change</button>
    </div>

    <div>
      Password: ••••••••
      <button id="changePasswordBtn">Change</button>
    </div>

    <button id="removeAccountBtn">Remove Account</button>
  </div>
</div>

<!-- POPUPS -->
<div class="overlay" id="removeOverlay">
  <div class="popup">
    <span class="close">✕</span>
    <input type="password" id="removePassword">
    <div class="error" id="removeError"></div>
    <button id="confirmRemoveBtn">Remove</button>
  </div>
</div>

<div class="overlay" id="usernameOverlay">
  <div class="popup">
    <span class="close">✕</span>
    <input id="newUsername">
    <div class="error" id="usernameError"></div>
    <button id="saveUsername">Save</button>
  </div>
</div>

<div class="overlay" id="passwordOverlay">
  <div class="popup">
    <span class="close">✕</span>
    <input id="currentPassword" type="password">
    <input id="newPassword" type="password">
    <input id="confirmPassword" type="password">
    <div class="error" id="passwordError"></div>
    <button id="savePassword">Save</button>
  </div>
</div>

<input type="file" id="pfpFile" accept="image/*" hidden>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, EmailAuthProvider, reauthenticateWithCredential, updatePassword, deleteUser } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDmRrflu-Ysm6DyxV65SrMZ0AL7TP58mX4",
  authDomain: "login-34954.firebaseapp.com",
  projectId: "login-34954"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* FIX #2 — CLOSE BUTTONS */
document.querySelectorAll(".close").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    btn.closest(".overlay").style.display="none";
  });
});

/* FIX #1 — PFP SYNC */
function applyPfp(img, letter, color){
  if(img){
    profilePic.style.backgroundImage = img;
    profilePic.textContent="";
    pfpPreview.style.backgroundImage = img;
    pfpPreview.textContent="";
  } else {
    profilePic.style.backgroundImage="";
    profilePic.textContent=letter;
    profilePic.style.background=color;
    pfpPreview.style.backgroundImage="";
    pfpPreview.textContent=letter;
    pfpPreview.style.background=color;
  }
}

let currentUser, username="";

onAuthStateChanged(auth, async user=>{
  if(!user) location.replace("login.html");
  currentUser=user;

  const snap = await getDocs(query(collection(db,"usernames"), where("uid","==",user.uid)));
  username = snap.empty ? user.email.split("@")[0] : snap.docs[0].id;

  panelUsername.textContent=username;
  usernameDisplay.textContent=username;

  const letter=username[0].toUpperCase();
  const color=`hsl(${username.charCodeAt(0)*7%360},70%,50%)`;

  const pfpDoc = await getDoc(doc(db,"userPFPs",user.uid));
  if(pfpDoc.exists() && pfpDoc.data().data){
    applyPfp(`url(${pfpDoc.data().data})`, letter, color);
  } else {
    applyPfp(null, letter, color);
  }
});

/* CHANGE PFP */
pfpFile.onchange=e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=async ev=>{
    await setDoc(doc(db,"userPFPs",currentUser.uid),{data:ev.target.result});
    applyPfp(`url(${ev.target.result})`, "", "");
  };
  reader.readAsDataURL(file);
};
</script>

</body>
</html>