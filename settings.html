<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Settings</title>
<link rel="icon" href="favicon.ico">
<style>
body {
  margin:0;
  min-height:100vh;
  background:radial-gradient(circle at top,#0b1e3d,#050b1a);
  font-family:system-ui,sans-serif;
  color:#e6f0ff;
  display:flex;
  justify-content:center;
  align-items:center;
  position:relative;
}
.card {
  width:90vw;
  max-width:500px;
  padding:30px;
  background:rgba(12,25,55,.65);
  backdrop-filter:blur(16px);
  border-radius:20px;
  box-shadow:0 20px 60px rgba(0,0,0,.4);
  text-align:center;
}
h2 { margin-bottom:20px; }

/* Profile pic top-right */
#profilePic {
  position:fixed;
  top:20px;
  right:20px;
  width:50px;
  height:50px;
  border-radius:50%;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  font-size:1.3rem;
  color:white;
  cursor:pointer;
  user-select:none;
  z-index:100;
  background-size:cover;
  background-position:center;
}

/* Profile panel */
#profilePanel {
  position:fixed;
  top:80px;
  right:20px;
  width:180px;
  background:rgba(12,25,55,.85);
  backdrop-filter:blur(8px);
  border-radius:14px;
  display:none;
  flex-direction:column;
  padding:10px;
  z-index:100;
}
#profilePanel h4 {
  margin:0 0 8px 0;
  font-size:1rem;
  text-align:center;
  border-bottom:1px solid rgba(255,255,255,0.2);
  padding-bottom:5px;
}
#profilePanel button {
  width:100%;
  margin:5px 0;
  padding:10px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}
.primary { background:#4da3ff; color:black; }
.remove { background:#ff4c4c; color:white; }

/* Overlay popups */
.overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  backdrop-filter:blur(6px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:200;
}
.popup {
  width:90vw;
  max-width:400px;
  background:#0c1937;
  padding:30px;
  border-radius:20px;
  text-align:center;
  position:relative;
}
.close { position:absolute; top:10px; right:15px; cursor:pointer; font-size:1.2rem; }
.error { color:#ff6b6b; margin-top:10px; min-height:1.2em; text-align:left; }
.success { color:#4caf50; margin-top:10px; min-height:1.2em; text-align:left; }

/* Settings form */
.setting-row {
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin:15px 0;
}
.setting-row button { width:auto; padding:5px 10px; font-size:0.9rem; }
.setting-row span { font-size:1rem; }

</style>
</head>
<body>

<div class="card">
  <h2>Settings</h2>
  <div id="accountSettings">
    <div class="setting-row">
      <span>Profile Picture</span>
      <div id="pfpPreview" style="width:40px;height:40px;border-radius:50%;background-color:#555;display:flex;align-items:center;justify-content:center;cursor:pointer;color:white;font-weight:bold;"></div>
    </div>
    <div class="setting-row">
      <span>Username</span>
      <span id="usernameText"></span>
      <button onclick="openUsernameChange()">Change</button>
    </div>
    <div class="setting-row">
      <span>Password</span>
      <span>••••••••</span>
      <button onclick="openPasswordChange()">Change</button>
    </div>
  </div>
</div>

<!-- Profile pic top-right -->
<div id="profilePic"></div>
<div id="profilePanel">
  <h4 id="profileName">Username</h4>
  <button class="primary" onclick="goDashboard()">Dashboard</button>
  <button class="primary" onclick="confirmLogout()">Logout</button>
</div>

<!-- POPUPS -->
<!-- Remove Account -->
<div class="overlay" id="removeOverlay">
  <div class="popup">
    <span class="close" onclick="closeRemoveAccount()">✕</span>
    <h2>Remove Account</h2>
    <p>Enter your password to confirm:</p>
    <input type="password" id="removePassword" placeholder="Password">
    <div class="error" id="removeError"></div>
    <button class="remove" onclick="removeAccount()">Yes, Remove</button>
  </div>
</div>

<!-- Logout confirmation -->
<div class="overlay" id="logoutOverlay">
  <div class="popup">
    <span class="close" onclick="closeLogout()">✕</span>
    <h2>Confirm Logout</h2>
    <button class="primary" onclick="logout()">Yes</button>
    <button class="remove" onclick="closeLogout()">No</button>
  </div>
</div>

<!-- Username change -->
<div class="overlay" id="usernameOverlay">
  <div class="popup">
    <span class="close" onclick="closeUsernameChange()">✕</span>
    <h2>Change Username</h2>
    <input type="text" id="newUsername" placeholder="New Username">
    <div class="error" id="usernameError"></div>
    <button class="primary" onclick="saveUsername()">Save</button>
  </div>
</div>

<!-- Password change -->
<div class="overlay" id="passwordOverlay">
  <div class="popup">
    <span class="close" onclick="closePasswordChange()">✕</span>
    <h2>Change Password</h2>
    <input type="password" id="currentPass" placeholder="Current Password">
    <input type="password" id="newPass" placeholder="New Password">
    <input type="password" id="confirmPass" placeholder="Confirm Password">
    <div class="error" id="passwordError"></div>
    <button class="primary" onclick="savePassword()">Save</button>
  </div>
</div>

<!-- PFP change -->
<div class="overlay" id="pfpOverlay">
  <div class="popup">
    <span class="close" onclick="closePfpChange()">✕</span>
    <h2>Change Profile Picture</h2>
    <input type="file" id="pfpFile" accept="image/*">
    <div class="error" id="pfpError"></div>
    <button class="primary" onclick="savePfp()">Save</button>
    <button class="remove" onclick="removePfp()">Remove</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
import { getAuth, signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, query, collection, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyDmRrflu-Ysm6DyxV65SrMZ0AL7TP58mX4",
  authDomain: "login-34954.firebaseapp.com",
  projectId: "login-34954",
  storageBucket: "login-34954.firebasestorage.app",
  messagingSenderId: "422184727508",
  appId: "1:422184727508:web:cef39fc913d526febe9c41",
  measurementId: "G-1MMT3C4M7K"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);

/* Elements */
const profilePic=document.getElementById("profilePic");
const profilePanel=document.getElementById("profilePanel");
const profileName=document.getElementById("profileName");
const pfpPreview=document.getElementById("pfpPreview");
const usernameText=document.getElementById("usernameText");

/* Popups */
const removeOverlay=document.getElementById("removeOverlay");
const removePassword=document.getElementById("removePassword");
const removeError=document.getElementById("removeError");

const logoutOverlay=document.getElementById("logoutOverlay");

const usernameOverlay=document.getElementById("usernameOverlay");
const newUsername=document.getElementById("newUsername");
const usernameError=document.getElementById("usernameError");

const passwordOverlay=document.getElementById("passwordOverlay");
const currentPass=document.getElementById("currentPass");
const newPass=document.getElementById("newPass");
const confirmPass=document.getElementById("confirmPass");
const passwordError=document.getElementById("passwordError");

const pfpOverlay=document.getElementById("pfpOverlay");
const pfpFile=document.getElementById("pfpFile");
const pfpError=document.getElementById("pfpError");

let panelOpen=false;
profilePic.addEventListener("click",()=>{ panelOpen=!panelOpen; profilePanel.style.display=panelOpen?"flex":"none"; });

function stringToColor(str){
  let hash=0; for(let i=0;i<str.length;i++){ hash=str.charCodeAt(i)+((hash<<5)-hash); }
  let color="#"; for(let i=0;i<3;i++){ const value=(hash>>(i*8))&0xFF;color+=("00"+value.toString(16)).slice(-2); } return color;
}

/* Auth check */
let currentUser=null;
onAuthStateChanged(auth, async(user)=>{
  if(!user) location.replace("login.html");
  currentUser=user;
  let username=user.displayName;
  if(!username){
    const q=query(collection(db,"usernames"),where("uid","==",user.uid));
    const snap=await getDocs(q);
    if(!snap.empty) username=snap.docs[0].id;
    else username=user.email.split("@")[0];
  }
  profileName.textContent=username;
  usernameText.textContent=username;

  const pfpDoc=await getDoc(doc(db,"userPFPs",user.uid));
  if(pfpDoc.exists() && pfpDoc.data().data){
    profilePic.style.backgroundImage=`url(${pfpDoc.data().data})`;
    profilePic.textContent="";
    pfpPreview.style.backgroundImage=`url(${pfpDoc.data().data})`;
    pfpPreview.textContent="";
  } else {
    profilePic.style.backgroundImage="";
    profilePic.textContent=username.charAt(0).toUpperCase();
    profilePic.style.backgroundColor=stringToColor(username.toLowerCase());
    pfpPreview.style.backgroundImage="";
    pfpPreview.style.backgroundColor=stringToColor(username.toLowerCase());
    pfpPreview.textContent=username.charAt(0).toUpperCase();
  }
});

/* Open/close popups */
function openUsernameChange(){ usernameOverlay.style.display="flex"; newUsername.value=""; usernameError.textContent=""; }
function closeUsernameChange(){ usernameOverlay.style.display="none"; }
function openPasswordChange(){ passwordOverlay.style.display="flex"; currentPass.value=""; newPass.value=""; confirmPass.value=""; passwordError.textContent=""; }
function closePasswordChange(){ passwordOverlay.style.display="none"; }
function closeRemoveAccount(){ removeOverlay.style.display="none"; }
function closeLogout(){ logoutOverlay.style.display="none"; }
function closePfpChange(){ pfpOverlay.style.display="none"; pfpFile.value=""; pfpError.textContent=""; }

/* Logout */
function confirmLogout(){ logoutOverlay.style.display="flex"; }
async function logout(){ await signOut(auth); location.replace("login.html"); }

/* Remove Account */
async function removeAccount(){
  removeError.textContent="";
  const pass=removePassword.value;
  if(!pass){ removeError.textContent="Enter password"; return; }
  try{
    const cred=EmailAuthProvider.credential(currentUser.email,pass);
    await reauthenticateWithCredential(currentUser,cred);
    const q=query(collection(db,"usernames"),where("uid","==",currentUser.uid));
    const snap=await getDocs(q);
    snap.forEach(async d=>await deleteDoc(doc(db,"usernames",d.id)));
    await deleteUser(currentUser);
    location.replace("login.html");
  }catch(e){ removeError.textContent=e.message; }
}

/* Open dashboard */
function goDashboard(){ location.replace("dashboard.html"); }

/* Username change */
async function saveUsername(){
  usernameError.textContent="";
  const val=newUsername.value.trim().toLowerCase();
  if(!val){ usernameError.textContent="Enter username"; return; }
  const snap=await getDoc(doc(db,"usernames",val));
  if(snap.exists()){ usernameError.textContent="Username in use"; return; }
  // Delete old username
  const q=query(collection(db,"usernames"),where("uid","==",currentUser.uid));
  const snapOld=await getDocs(q);
  snapOld.forEach(async d=>await deleteDoc(doc(db,"usernames",d.id)));
  await setDoc(doc(db,"usernames",val),{uid:currentUser.uid,email:currentUser.email});
  profileName.textContent=newUsername.value.trim();
  usernameText.textContent=newUsername.value.trim();
  if(!profilePic.style.backgroundImage) profilePic.textContent=newUsername.value.charAt(0).toUpperCase();
  closeUsernameChange();
}

/* Password change */
async function savePassword(){
  passwordError.textContent="";
  if(!currentPass.value || !newPass.value || !confirmPass.value){ passwordError.textContent="Fill all fields"; return; }
  if(newPass.value!==confirmPass.value){ passwordError.textContent="Passwords do not match"; return; }
  try{
    const cred=EmailAuthProvider.credential(currentUser.email,currentPass.value);
    await reauthenticateWithCredential(currentUser,cred);
    await updatePassword(currentUser,newPass.value);
    closePasswordChange();
  }catch(e){ passwordError.textContent=e.message; }
}

/* PFP change */
let selectedPfp=null;
pfpPreview.addEventListener("click",()=>{ pfpOverlay.style.display="flex"; });
pfpFile.addEventListener("change",()=>{ selectedPfp=null; pfpError.textContent=""; const file=pfpFile.files[0]; if(file){ const reader=new FileReader(); reader.onload=()=>{ selectedPfp=reader.result; }; reader.readAsDataURL(file); } });
async function savePfp(){
  if(!selectedPfp){ pfpError.textContent="Select a file"; return; }
  await setDoc(doc(db,"userPFPs",currentUser.uid),{data:selectedPfp});
  profilePic.style.backgroundImage=`url(${selectedPfp})`;
  profilePic.textContent="";
  pfpPreview.style.backgroundImage=`url(${selectedPfp})`;
  pfpPreview.textContent="";
  closePfpChange();
}
async function removePfp(){
  await setDoc(doc(db,"userPFPs",currentUser.uid),{data:""});
  const username=usernameText.textContent;
  profilePic.style.backgroundImage="";
  profilePic.textContent=username.charAt(0).toUpperCase();
  profilePic.style.backgroundColor=stringToColor(username.toLowerCase());
  pfpPreview.style.backgroundImage="";
  pfpPreview.textContent=username.charAt(0).toUpperCase();
  pfpPreview.style.backgroundColor=stringToColor(username.toLowerCase());
  closePfpChange();
}

</script>
</body>
</html>