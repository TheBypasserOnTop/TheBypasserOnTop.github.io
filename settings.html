<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Settings</title>
<link rel="icon" href="favicon.ico">

<style>
body{
  margin:0;
  min-height:100vh;
  background:radial-gradient(circle at top,#0b1e3d,#050b1a);
  font-family:system-ui,sans-serif;
  color:#e6f0ff;
}

/* Card */
.card{
  width:90%;
  max-width:400px;
  padding:25px;
  background:rgba(12,25,55,.65);
  backdrop-filter:blur(16px);
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.4);
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
}

/* Profile Pic */
#profilePic{
  position:fixed;
  top:15px;
  right:15px;
  width:50px;
  height:50px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  font-size:1.3rem;
  cursor:pointer;
  color:white;
  z-index:100;
}

/* Profile Panel */
#profilePanel{
  position:fixed;
  top:75px;
  right:15px;
  width:180px;
  background:rgba(12,25,55,.85);
  backdrop-filter:blur(12px);
  border-radius:14px;
  display:none;
  flex-direction:column;
  padding:10px;
  z-index:100;
}
#profilePanel button{
  margin:5px 0;
  padding:8px;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}

/* Section */
.section{
  background:rgba(0,0,0,.25);
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
}

/* PFP preview */
#pfpPreview{
  width:50px;
  height:50px;
  border-radius:50%;
  display:inline-flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  color:white;
  cursor:pointer;
  background-size:cover;
}

/* PFP panel */
#pfpPanel{
  display:none;
  position:absolute;
  background:rgba(12,25,55,.85);
  backdrop-filter:blur(12px);
  padding:8px;
  border-radius:10px;
  flex-direction:column;
}

/* Overlay FIX */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  backdrop-filter:blur(6px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:20;
  pointer-events:none;
}
.overlay.show{
  display:flex;
  pointer-events:auto;
}

.popup{
  width:90vw;
  max-width:400px;
  background:#0c1937;
  padding:30px;
  border-radius:20px;
}
.close{
  float:right;
  cursor:pointer;
}
.error{ color:#ff4c4c; }
</style>
</head>

<body>

<div id="profilePic"></div>

<div id="profilePanel">
  <button onclick="location.replace('dashboard.html')">Dashboard</button>
  <button id="logoutBtn">Logout</button>
</div>

<div class="card">
  <h2>Settings</h2>

  <div class="section">
    Profile Picture:
    <div id="pfpPreview"></div>
    <div id="pfpPanel">
      <button id="changePfpBtn">Change</button>
      <button id="removePfpBtn">Remove</button>
      <button id="viewPfpBtn">View</button>
    </div>

    <br><br>
    Username: <span id="usernameDisplay"></span>
    <button id="changeUsernameBtn">Change</button>

    <br><br>
    Password: ••••••••
    <button id="changePasswordBtn">Change</button>

    <br><br>
    <button id="removeAccountBtn">Remove Account</button>
  </div>
</div>

<!-- POPUPS -->
<div class="overlay" id="removeOverlay">
  <div class="popup">
    <span class="close">✕</span>
    <input id="removePassword" type="password" placeholder="Password">
    <div class="error" id="removeError"></div>
    <button id="confirmRemoveBtn">Remove</button>
  </div>
</div>

<input type="file" id="pfpFile" accept="image/*" hidden>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged, EmailAuthProvider, reauthenticateWithCredential, deleteUser } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyDmRrflu-Ysm6DyxV65SrMZ0AL7TP58mX4",
  authDomain:"login-34954.firebaseapp.com",
  projectId:"login-34954"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const profilePic = document.getElementById("profilePic");
const pfpPreview = document.getElementById("pfpPreview");
const pfpFile = document.getElementById("pfpFile");
const pfpPanel = document.getElementById("pfpPanel");
const removeOverlay = document.getElementById("removeOverlay");

function openOverlay(o){ o.classList.add("show"); }
function closeOverlay(o){ o.classList.remove("show"); }

document.querySelectorAll(".close").forEach(x=>{
  x.onclick=()=>closeOverlay(x.closest(".overlay"));
});

function colorFrom(str){
  let h=0; for(let c of str) h=c.charCodeAt(0)+((h<<5)-h);
  return `hsl(${h%360},70%,50%)`;
}

onAuthStateChanged(auth, async user=>{
  if(!user) location.replace("login.html");

  let name=user.email.split("@")[0];
  const snap=await getDocs(query(collection(db,"usernames"),where("uid","==",user.uid)));
  if(!snap.empty) name=snap.docs[0].id;

  profilePic.textContent=name[0].toUpperCase();
  profilePic.style.background=colorFrom(name);
  pfpPreview.textContent=name[0].toUpperCase();
  pfpPreview.style.background=colorFrom(name);

  const pfpDoc=await getDoc(doc(db,"userPFPs",user.uid));
  if(pfpDoc.exists() && pfpDoc.data().data){
    profilePic.style.backgroundImage=`url(${pfpDoc.data().data})`;
    profilePic.textContent="";
    pfpPreview.style.backgroundImage=`url(${pfpDoc.data().data})`;
    pfpPreview.textContent="";
  }
});

profilePic.onclick=()=>{
  profilePanel.style.display = profilePanel.style.display==="flex"?"none":"flex";
};

pfpPreview.onclick=()=>{
  pfpPanel.style.display = pfpPanel.style.display==="flex"?"none":"flex";
};

changePfpBtn.onclick=()=>pfpFile.click();

pfpFile.onchange=e=>{
  const file=e.target.files[0];
  const r=new FileReader();
  r.onload=async ev=>{
    pfpPreview.style.backgroundImage=`url(${ev.target.result})`;
    profilePic.style.backgroundImage=`url(${ev.target.result})`;
    pfpPreview.textContent="";
    profilePic.textContent="";
    await setDoc(doc(db,"userPFPs",auth.currentUser.uid),{data:ev.target.result});
  };
  r.readAsDataURL(file);
};

logoutBtn.onclick=async()=>{
  await signOut(auth);
  location.replace("login.html");
};

removeAccountBtn.onclick=()=>openOverlay(removeOverlay);

confirmRemoveBtn.onclick=async()=>{
  const pass=removePassword.value;
  const cred=EmailAuthProvider.credential(auth.currentUser.email,pass);
  await reauthenticateWithCredential(auth.currentUser,cred);
  const snap=await getDocs(query(collection(db,"usernames"),where("uid","==",auth.currentUser.uid)));
  snap.forEach(d=>deleteDoc(d.ref));
  await deleteUser(auth.currentUser);
  location.replace("login.html");
};
</script>
</body>
</html>