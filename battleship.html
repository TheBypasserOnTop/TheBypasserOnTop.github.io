<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSMIC | Battleship</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --accent: #a855f7; --border: rgba(255, 255, 255, 0.1); }
        body { margin: 0; padding: 0; background: radial-gradient(circle at top, #1e1b4b, #020617); color: #e6f0ff; font-family: 'Inter', sans-serif; min-height: 100vh; overflow-x: hidden; }
        
        /* Grid Styling */
        .grid-container { display: grid; grid-template-columns: repeat(10, 30px); grid-template-rows: repeat(10, 30px); gap: 2px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 8px; border: 1px solid var(--border); }
        .cell { width: 30px; height: 30px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; position: relative; }
        .cell:hover { background: rgba(168, 85, 247, 0.2); }
        
        /* State Colors */
        .cell.ship { background: #64748b; border: 1px solid #94a3b8; } /* Your Ship */
        .cell.hit { background: #ef4444 !important; box-shadow: inset 0 0 10px #000; } /* Hit */
        .cell.miss { background: #3b82f6 !important; opacity: 0.5; } /* Miss */
        .cell.selected { border: 2px solid var(--accent); }

        .side-panel { width: 300px; background: rgba(10, 10, 25, 0.7); backdrop-filter: blur(30px); border: 1px solid var(--border); height: 75vh; border-radius: 28px; display: flex; flex-direction: column; }
        .chat-area { flex-grow: 1; overflow-y: auto; padding: 15px; font-size: 12px; scrollbar-width: none; }
        .stars-container { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .star { position: absolute; background: white; border-radius: 50%; animation: pulse var(--duration) infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { opacity: 0.1; } 50% { opacity: 0.8; } }
        .hidden { display: none !important; }
    </style>
</head>
<body class="flex flex-col items-center">

<div class="stars-container" id="starField"></div>

<nav class="w-full px-10 py-8 flex justify-between items-center z-50">
    <button onclick="location.href='games.html'" class="text-[10px] font-black uppercase tracking-[0.3em] text-white/40 hover:text-white transition">‚Üê Return</button>
    <div id="profilePic" class="w-10 h-10 rounded-full border border-white/10 bg-white/5 bg-cover bg-center"></div>
</nav>

<div id="menu-view" class="mt-20 text-center z-10">
    <h2 class="text-5xl font-black mb-8 uppercase tracking-tighter italic">Battleship</h2>
    <div class="flex flex-col gap-4">
        <button onclick="setupGame('host')" class="px-10 py-4 bg-white text-black font-black rounded-xl hover:bg-purple-500 hover:text-white transition uppercase">Host Battle</button>
        <p class="text-[10px] font-bold opacity-30 uppercase tracking-[0.5em] cursor-pointer hover:opacity-100" onclick="$('#join-input-area').toggle()">Join Fleet</p>
    </div>
    <div id="join-input-area" class="hidden mt-6">
        <input type="text" id="joinCodeInput" placeholder="CODE" class="bg-white/5 border border-white/10 p-4 rounded-xl text-center text-white mb-4 outline-none">
        <button onclick="executeJoin()" class="block mx-auto text-xs font-bold text-purple-400 uppercase">Connect</button>
    </div>
</div>

<div id="game-view" class="hidden flex gap-8 mt-10 w-full px-10 justify-center items-start">
    
    <div class="side-panel p-6">
        <h3 class="font-black text-[10px] uppercase tracking-widest text-white/40 mb-4">Tactical Status</h3>
        <div id="status-text" class="text-sm font-bold text-purple-400 mb-6">Placing Ships...</div>
        <div id="placement-controls">
            <p class="text-[10px] text-white/40 mb-2">Click 5 cells to place your fleet.</p>
            <button onclick="submitShips()" class="w-full py-3 bg-white/10 border border-white/20 rounded-xl text-[10px] font-bold uppercase hover:bg-purple-600 transition">Confirm Fleet</button>
        </div>
        <div id="game-stats" class="hidden mt-auto space-y-2 text-[10px] uppercase font-bold text-white/20">
            <div class="flex justify-between"><span>Your Hits</span><span id="stat-hits" class="text-white">0</span></div>
            <div class="flex justify-between"><span>Turn</span><span id="stat-turn" class="text-white">-</span></div>
        </div>
    </div>

    <div class="flex flex-col gap-8 items-center">
        <div class="flex flex-col items-center">
            <span class="text-[10px] font-black uppercase tracking-widest mb-2 opacity-30">Attack Grid (Enemy)</span>
            <div id="attack-grid" class="grid-container"></div>
        </div>
        <div class="flex flex-col items-center">
            <span class="text-[10px] font-black uppercase tracking-widest mb-2 opacity-30">Defense Grid (You)</span>
            <div id="defense-grid" class="grid-container"></div>
        </div>
    </div>

    <div class="side-panel">
        <div class="p-6 border-b border-white/5 font-black text-[10px] uppercase tracking-widest text-white/40">Comms</div>
        <div id="chatArea" class="chat-area"></div>
        <div class="p-6">
            <input type="text" id="chatInput" placeholder="Transmission..." class="bg-white/5 border border-white/10 p-4 rounded-2xl w-full text-xs outline-none focus:border-purple-500" onkeydown="if(event.key==='Enter') sendChat()">
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, collection, query, addDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const config = { apiKey: "AIzaSyDmRrflu-Ysm6DyxV65SrMZ0AL7TP58mX4", authDomain: "login-34954.firebaseapp.com", projectId: "login-34954", storageBucket: "login-34954.firebasestorage.app", messagingSenderId: "422184727508", appId: "1:422184727508:web:cef39fc913d526febe9c41" };
    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let myUsername = "", gameCode = "", playerRole = "";
    let myShips = []; 
    let myTurn = false;
    let gameData = null;

    onAuthStateChanged(auth, async user => {
        if (!user) return;
        myUsername = user.email.split('@')[0];
        const pfpDoc = await getDoc(doc(db, "userPFPs", user.uid));
        if(pfpDoc.exists()) document.getElementById("profilePic").style.backgroundImage = `url(${pfpDoc.data().data})`;
    });

    // Create Grids
    function createGrids() {
        for (let i = 0; i < 100; i++) {
            $('#defense-grid').append(`<div class="cell" data-index="${i}" onclick="placeShip(${i})"></div>`);
            $('#attack-grid').append(`<div class="cell" data-index="${i}" onclick="fireShot(${i})"></div>`);
        }
    }

    window.setupGame = async () => {
        gameCode = Math.floor(1000 + Math.random() * 9000).toString();
        playerRole = 'host';
        await setDoc(doc(db, "battleship", gameCode), {
            host: myUsername, guest: "", 
            hostShips: [], guestShips: [],
            hostHits: [], guestHits: [],
            status: "placing", turn: "host", lastShotResult: ""
        });
        startSync();
    };

    window.executeJoin = async () => {
        gameCode = $('#joinCodeInput').val().trim();
        playerRole = 'guest';
        const snap = await getDoc(doc(db, "battleship", gameCode));
        if (snap.exists()) {
            await updateDoc(doc(db, "battleship", gameCode), { guest: myUsername });
            startSync();
        }
    };

    function startSync() {
        $('#menu-view').addClass('hidden');
        $('#game-view').removeClass('hidden');
        createGrids();

        onSnapshot(doc(db, "battleship", gameCode), (snap) => {
            gameData = snap.data();
            renderGrids();
            checkGameState();
        });

        const chatQuery = query(collection(db, `battleship/${gameCode}/messages`), orderBy("time", "asc"));
        onSnapshot(chatQuery, (snap) => {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = "";
            snap.forEach(m => {
                chatArea.innerHTML += `<div class="mb-2"><span class="text-purple-400 font-bold">${m.data().user}:</span> <span>${m.data().msg}</span></div>`;
            });
            chatArea.scrollTop = chatArea.scrollHeight;
        });
    }

    window.placeShip = (i) => {
        if (gameData.status !== "placing") return;
        const index = myShips.indexOf(i);
        if (index > -1) myShips.splice(index, 1);
        else if (myShips.length < 5) myShips.push(i);
        
        $('#defense-grid .cell').removeClass('ship');
        myShips.forEach(s => $(`#defense-grid .cell[data-index="${s}"]`).addClass('ship'));
    };

    window.submitShips = async () => {
        if (myShips.length < 5) return alert("Place all 5 ships!");
        const field = playerRole === 'host' ? 'hostShips' : 'guestShips';
        await updateDoc(doc(db, "battleship", gameCode), { [field]: myShips });
        $('#placement-controls').addClass('hidden');
        $('#status-text').text("Waiting for opponent...");
    };

    function checkGameState() {
        if (gameData.hostShips.length === 5 && gameData.guestShips.length === 5 && gameData.status === "placing") {
            updateDoc(doc(db, "battleship", gameCode), { status: "playing" });
        }

        if (gameData.status === "playing") {
            myTurn = gameData.turn === playerRole;
            $('#status-text').text(myTurn ? "Your Turn - Fire!" : "Opponent's Turn...");
            $('#status-text').css('color', myTurn ? '#a855f7' : '#ffffff40');
            $('#game-stats').removeClass('hidden');
            $('#stat-turn').text(gameData.turn.toUpperCase());
        }
    }

    window.fireShot = async (i) => {
        if (!myTurn || gameData.status !== "playing") return;
        
        const enemyShips = playerRole === 'host' ? gameData.guestShips : gameData.hostShips;
        const myHitsField = playerRole === 'host' ? 'hostHits' : 'guestHits';
        const currentHits = gameData[myHitsField];

        if (currentHits.includes(i)) return; // Already shot here

        const isHit = enemyShips.includes(i);
        const newHits = [...currentHits, i];
        
        let updates = { [myHitsField]: newHits };

        if (!isHit) {
            myTurn = false; // Local block
            updates.turn = playerRole === 'host' ? 'guest' : 'host';
            // 3 Second Delay for Miss
            $('#status-text').text("MISS! Switching turns...");
            setTimeout(() => {
                updateDoc(doc(db, "battleship", gameCode), updates);
            }, 3000);
        } else {
            // It's a hit! Check for win
            if (newHits.filter(h => enemyShips.includes(h)).length === 5) {
                updates.status = "finished";
                alert("VICTORY! All enemy ships destroyed.");
            }
            updateDoc(doc(db, "battleship", gameCode), updates);
        }
    };

    function renderGrids() {
        // Render Defense Grid (Your ships + enemy shots)
        const enemyHits = playerRole === 'host' ? gameData.guestHits : gameData.hostHits;
        $('#defense-grid .cell').removeClass('hit miss');
        enemyHits.forEach(i => {
            const isHit = myShips.includes(i);
            $(`#defense-grid .cell[data-index="${i}"]`).addClass(isHit ? 'hit' : 'miss');
        });

        // Render Attack Grid (Your shots)
        const myHits = playerRole === 'host' ? gameData.hostHits : gameData.guestHits;
        const enemyShips = playerRole === 'host' ? gameData.guestShips : gameData.hostShips;
        $('#attack-grid .cell').removeClass('hit miss');
        myHits.forEach(i => {
            const isHit = enemyShips.includes(i);
            $(`#attack-grid .cell[data-index="${i}"]`).addClass(isHit ? 'hit' : 'miss');
        });
        
        $('#stat-hits').text(myHits.filter(i => enemyShips.includes(i)).length);
    }

    window.sendChat = async () => {
        const input = $('#chatInput');
        if (!input.val().trim()) return;
        await addDoc(collection(db, `battleship/${gameCode}/messages`), { user: myUsername, msg: input.val(), time: Date.now() });
        input.val("");
    };

    // Stars
    for (let i = 0; i < 50; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.width = star.style.height = '1px';
        star.style.left = Math.random() * 100 + '%'; star.style.top = Math.random() * 100 + '%';
        star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
        document.getElementById('starField').appendChild(star);
    }
</script>
</body>
</html>
