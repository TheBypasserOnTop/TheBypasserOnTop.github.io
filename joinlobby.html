<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSMIC | Player Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --accent: #a855f7; --border: rgba(255, 255, 255, 0.1); }
        body {
            margin: 0; padding: 0;
            background: radial-gradient(circle at top, #1e1b4b, #020617);
            color: #e6f0ff; font-family: 'Inter', sans-serif;
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
        }
        .stars-container { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .star { position: absolute; background: white; border-radius: 50%; animation: pulse var(--duration) infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { opacity: 0.1; transform: scale(0.8); } 50% { opacity: 0.8; transform: scale(1.4); } }
        
        .input-box { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); padding: 18px; border-radius: 16px; width: 100%; color: white; text-align: center; outline: none; transition: 0.3s; font-weight: 800; }
        .input-box.error { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .game-header { position: fixed; top: 0; left: 0; width: 100%; padding: 15px 30px; display: flex; justify-content: space-between; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); z-index: 100; }
        
        .ans-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); padding: 25px; border-radius: 20px; font-weight: 800; transition: 0.2s; text-align: center; width: 100%; }
        .ans-btn:active { transform: scale(0.95); }
        .ans-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="stars-container" id="starField"></div>

    <div id="lobby-header" class="game-header hidden">
        <div class="text-left"><p class="text-[10px] font-bold opacity-40 uppercase">PIN</p><p id="header-pin" class="font-black text-purple-400">000000</p></div>
        <div class="text-center"><p class="text-[10px] font-bold opacity-40 uppercase">Time</p><p id="timer-display" class="font-black">10s</p></div>
        <div class="text-right"><p class="text-[10px] font-bold opacity-40 uppercase">Score</p><p id="header-score" class="font-black">0</p></div>
    </div>

    <div id="step-pin" class="max-w-xs w-full p-8 text-center">
        <h1 class="text-3xl font-black mb-8 uppercase">Join Void</h1>
        <input type="number" id="pinInput" class="input-box mb-4" placeholder="ENTER PIN">
        <p id="pin-error" class="text-red-500 text-[10px] font-bold uppercase mb-4 opacity-0">Invalid Access Code</p>
        <button onclick="checkPin()" class="w-full bg-white text-black py-4 rounded-xl font-black uppercase hover:bg-purple-500 hover:text-white transition">Verify</button>
    </div>

    <div id="step-name" class="hidden max-w-xs w-full p-8 text-center">
        <h1 class="text-3xl font-black mb-8 uppercase">Identify</h1>
        <input type="text" id="nameInput" class="input-box mb-6" placeholder="NICKNAME">
        <button onclick="joinLobby()" class="w-full bg-purple-600 text-white py-4 rounded-xl font-black uppercase">Enter</button>
    </div>

    <div id="game-container" class="hidden w-full max-w-xl p-6 text-center">
        <div id="waiting-area">
            <h1 id="status-text" class="text-4xl font-black mb-4 italic text-purple-500 animate-pulse">WAITING...</h1>
            <p id="participant-info" class="text-white/20 text-xs font-bold uppercase tracking-widest">Awaiting Host Initialization</p>
        </div>

        <div id="question-area" class="hidden">
            <h2 id="current-q-text" class="text-xl font-bold mb-8">Selecting Question...</h2>
            <div class="grid grid-cols-1 gap-4" id="answer-grid">
                <button class="ans-btn" onclick="submitAnswer(0)" id="btn-0"></button>
                <button class="ans-btn" onclick="submitAnswer(1)" id="btn-1"></button>
                <button class="ans-btn" onclick="submitAnswer(2)" id="btn-2"></button>
                <button class="ans-btn" onclick="submitAnswer(3)" id="btn-3"></button>
            </div>
        </div>

        <div id="feedback-area" class="hidden">
            <h1 id="feedback-text" class="text-5xl font-black mb-4"></h1>
            <p id="feedback-sub" class="text-white/30 font-bold uppercase"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const config = { apiKey: "AIzaSyDmRrflu-Ysm6DyxV65SrMZ0AL7TP58mX4", authDomain: "login-34954.firebaseapp.com", projectId: "login-34954", storageBucket: "login-34954.firebasestorage.app", messagingSenderId: "422184727508", appId: "1:422184727508:web:cef39fc913d526febe9c41" };
        const app = initializeApp(config);
        const db = getFirestore(app);

        // --- PRE-MADE TEMPLATES (Must match Host exactly) ---
        const QUIZZES = {
            "Cosmic Trivia": [
                { q: "Which planet is known as the Red Planet?", a: ["Venus", "Mars", "Jupiter", "Saturn"], correct: 1 },
                { q: "What is the speed of light approx?", a: ["300k km/s", "150k km/s", "1m km/s", "500k km/s"], correct: 0 }
            ],
            "Shield Protocols": [
                { q: "What does VPN stand for?", a: ["Virtual Private Net", "Very Personal Node", "Virtual Proxy Network", "Valid Port Name"], correct: 0 },
                { q: "Which is a hashing algorithm?", a: ["AES", "RSA", "SHA-256", "HTTP"], correct: 2 }
            ],
            "Quantum Math": [
                { q: "Solve: 12 * 12", a: ["122", "144", "164", "142"], correct: 1 },
                { q: "Square root of 81?", a: ["7", "8", "9", "10"], correct: 2 }
            ]
        };

        let currentPin = "";
        let myId = Math.random().toString(36).substring(7);
        let myScore = 0;
        let hasAnswered = false;
        let activeQuizData = [];

        window.onbeforeunload = () => "Game in progress. Leave?";

        window.checkPin = async () => {
            const pin = document.getElementById('pinInput').value;
            const snap = await getDoc(doc(db, "lobbies", pin));
            if (snap.exists()) {
                currentPin = pin;
                document.getElementById('step-pin').classList.add('hidden');
                document.getElementById('step-name').classList.remove('hidden');
            } else {
                document.getElementById('pinInput').classList.add('error');
                document.getElementById('pin-error').classList.remove('opacity-0');
            }
        };

        window.joinLobby = async () => {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) return;

            const playerRef = doc(db, "lobbies", currentPin, "players", myId);
            await setDoc(playerRef, { username: name, score: 0 });

            document.getElementById('step-name').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            document.getElementById('lobby-header').classList.remove('hidden');
            document.getElementById('header-pin').innerText = currentPin;

            // KICK LISTENER
            onSnapshot(playerRef, (snap) => { if (!snap.exists()) location.reload(); });

            // MAIN GAME LISTENER
            onSnapshot(doc(db, "lobbies", currentPin), (snap) => {
                const data = snap.data();
                activeQuizData = QUIZZES[data.quizName];
                handleGameState(data);
            });
        };

        function handleGameState(data) {
            const statusText = document.getElementById('status-text');
            const waitingArea = document.getElementById('waiting-area');
            const questionArea = document.getElementById('question-area');
            const feedbackArea = document.getElementById('feedback-area');

            if (data.status === "countdown") {
                statusText.innerText = "GET READY";
            } 
            else if (data.status === "live") {
                waitingArea.classList.add('hidden');
                feedbackArea.classList.add('hidden');
                questionArea.classList.remove('hidden');
                
                if (!hasAnswered) {
                    const q = activeQuizData[data.currentQ];
                    document.getElementById('current-q-text').innerText = q.q;
                    q.a.forEach((ans, i) => {
                        const btn = document.getElementById(`btn-${i}`);
                        btn.innerText = ans;
                        btn.disabled = false;
                        btn.style.background = "rgba(255,255,255,0.05)";
                    });
                }
            }
            else if (data.status === "review") {
                showFeedback(data.currentQ);
            }
            else if (data.status === "finished") {
                questionArea.classList.add('hidden');
                feedbackArea.classList.remove('hidden');
                document.getElementById('feedback-text').innerText = "FINISH";
                document.getElementById('feedback-sub').innerText = `Final Score: ${myScore}`;
            }
        }

        window.submitAnswer = async (idx) => {
            if (hasAnswered) return;
            hasAnswered = true;
            
            // Disable buttons
            for(let i=0; i<4; i++) document.getElementById(`btn-${i}`).disabled = true;
            document.getElementById(`btn-${idx}`).style.background = "var(--accent)";

            const lobbyRef = doc(db, "lobbies", currentPin);
            const playerRef = doc(db, "lobbies", currentPin, "players", myId);
            const currentQ = (await getDoc(lobbyRef)).data().currentQ;
            const correctIdx = activeQuizData[currentQ].correct;

            if (idx === correctIdx) {
                myScore += 100;
                document.getElementById('header-score').innerText = myScore;
                await updateDoc(playerRef, { score: increment(100) });
            }

            await updateDoc(lobbyRef, { answersReceived: increment(1) });
            document.getElementById('current-q-text').innerText = "Answer Sent. Waiting for others...";
        };

        function showFeedback(qIdx) {
            hasAnswered = false; // Reset for next Q
            document.getElementById('question-area').classList.add('hidden');
            const feedbackArea = document.getElementById('feedback-area');
            feedbackArea.classList.remove('hidden');
            
            document.getElementById('feedback-text').innerText = "ROUND OVER";
            document.getElementById('feedback-sub').innerText = "Check host screen for results";
        }

        // Stars
        const field = document.getElementById('starField');
        for (let i = 0; i < 50; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.width = s.style.height = `${Math.random() * 2 + 1}px`;
            s.style.left = `${Math.random() * 100}%`; s.style.top = `${Math.random() * 100}%`;
            s.style.setProperty('--duration', `${2 + Math.random() * 4}s`);
            field.appendChild(s);
        }
    </script>
</body>
</html>
