<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<link rel="icon" href="favicon.ico">
<style>
html, body {
  margin:0;
  padding:0;
  min-height:100%;
  font-family:system-ui,sans-serif;
  background:radial-gradient(circle at top,#0b1e3d,#050b1a);
  color:#e6f0ff;
  overflow:hidden;
  position:relative;
}

/* Hamburger menu */
#menuBtn {
  position:fixed;
  top:20px;
  left:20px;
  width:32px;
  height:24px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  cursor:pointer;
  z-index:150;
  transition:opacity .3s, transform .3s;
}
#menuBtn span {
  height:4px;
  background:white;
  border-radius:4px;
}
body.menu-open #menuBtn { opacity:0; pointer-events:none; transform:scale(0.8); }

/* Side panel */
#sidePanel {
  position:fixed;
  top:0;
  left:-300px;
  width:260px;
  height:100%;
  background:rgba(12,25,55,.95);
  backdrop-filter:blur(16px);
  padding:20px;
  box-sizing:border-box;
  z-index:200;
  transition:left .35s ease;
  display:flex;
  flex-direction:column;
}
body.menu-open #sidePanel { left:0; }

/* Side panel header */
#sidePanelHeader {
  display:flex;
  justify-content:space-between;
  align-items:center;
}
#sidePanelHeader h3 { margin:0 auto; }
#closeMenu { cursor:pointer; font-size:1.4rem; }

/* Divider */
.divider { height:1px; background:rgba(255,255,255,.2); margin:15px 0; }

/* Search */
#navSearch {
  padding:10px;
  border-radius:10px;
  border:none;
  background:rgba(255,255,255,.08);
  color:white;
  margin-bottom:15px;
}

/* Tabs */
.nav-tab {
  padding:12px;
  border-radius:10px;
  cursor:pointer;
  margin-bottom:8px;
  font-weight:600;
}
.nav-tab.active { background:#4da3ff; color:black; }
.nav-tab:not(.active):hover { background:rgba(255,255,255,.1); }

/* Blur layer */
.blur-layer {
  position:absolute;
  inset:0;
  z-index:5;
}
body.menu-open .blur-layer {
  backdrop-filter: blur(8px);
  pointer-events:none;
}

/* Top-right PFP */
#profilePic {
  position:fixed;
  top:20px;
  right:20px;
  width:50px;
  height:50px;
  border-radius:50%;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  font-size:1.3rem;
  color:white;
  cursor:pointer;
  user-select:none;
  z-index:100;
  background-size:cover;
  background-position:center;
}

/* Profile panel */
#profilePanel {
  position:fixed;
  top:80px;
  right:20px;
  width:180px;
  background:rgba(12,25,55,.85);
  backdrop-filter:blur(8px);
  border-radius:14px;
  display:none;
  flex-direction:column;
  padding:10px;
  z-index:100;
}
#profilePanel h4 {
  margin:0 0 8px 0;
  font-size:1rem;
  text-align:center;
  border-bottom:1px solid rgba(255,255,255,0.2);
  padding-bottom:5px;
}
#profilePanel button {
  width:100%;
  margin:5px 0;
  padding:10px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}
.primary { background:#4da3ff; color:black; }
.remove { background:#ff4c4c; color:white; }

/* Chat container */
#chatWrapper {
  position:absolute;
  top:0;
  bottom:60px;
  left:0;
  right:0;
  overflow-y:auto;
  padding:80px 15px 0 15px;
  box-sizing:border-box;
}
.chat-header {
  position:fixed;
  top:0;
  left:0;
  right:0;
  background:rgba(12,25,55,.85);
  backdrop-filter:blur(10px);
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:600;
  font-size:1.2rem;
  z-index:120;
  border-bottom:1px solid rgba(255,255,255,0.2);
}

/* Messages */
.message {
  display:flex;
  align-items:flex-start;
  margin-bottom:15px;
}
.message.owner { flex-direction:row-reverse; }
.message .msgContent {
  max-width:70%;
  background:rgba(12,25,55,.7);
  padding:12px;
  border-radius:12px;
  position:relative;
}
.message.owner .msgContent { background:#4da3ff; color:black; }
.msgContent .username { font-weight:600; font-size:0.85rem; margin-bottom:3px; }
.msgContent .time { font-size:0.7rem; color:#ccc; margin-top:5px; }
.msgContent .edited { font-size:0.65rem; color:#ffda6b; }
.message .pfp { width:35px; height:35px; border-radius:50%; margin-right:8px; background-size:cover; background-position:center; flex-shrink:0; }
.message.owner .pfp { margin-left:8px; margin-right:0; }
.message .actions { display:flex; gap:5px; margin-top:5px; font-size:0.7rem; }
.message .actions button { cursor:pointer; border:none; padding:2px 6px; border-radius:5px; font-size:0.7rem; }
.message .replyPreview { font-size:0.75rem; color:#cfd8f0; background:rgba(255,255,255,0.1); padding:4px 6px; border-radius:6px; margin-bottom:3px; }

/* Input bar */
#chatInputWrapper {
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  display:flex;
  padding:5px 10px;
  background:rgba(12,25,55,.85);
  backdrop-filter:blur(10px);
  gap:5px;
  z-index:100;
}
#replyPreview {
  flex:1 1 100%;
  background:rgba(255,255,255,0.1);
  padding:5px 10px;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  font-size:0.8rem;
  margin-bottom:5px;
}
#replyPreview span { font-size:0.8rem; }
#cancelReply { cursor:pointer; font-weight:600; }
#chatInput { flex:1; padding:10px; border-radius:10px; border:none; }
#sendBtn { padding:0 12px; border-radius:10px; border:none; cursor:pointer; font-size:1.1rem; }
</style>
</head>
<body>

<!-- Menu -->
<div id="menuBtn"><span></span><span></span><span></span></div>
<div id="sidePanel">
  <div id="sidePanelHeader"><div></div><h3>Navigation</h3><div id="closeMenu">✕</div></div>
  <div class="divider"></div>
  <input id="navSearch" placeholder="Search...">
  <div class="nav-tab" id="tabDashboard">Dashboard</div>
  <div class="nav-tab active" id="tabCommunicate">Communicate</div>
  <div class="nav-tab" id="tabSettings">Settings</div>
</div>
<div class="blur-layer"></div>

<!-- Profile pic -->
<div id="profilePic"></div>
<div id="profilePanel">
  <h4 id="profileName">Username</h4>
  <button class="primary" onclick="location.href='settings.html'">Settings</button>
  <button class="primary" onclick="confirmLogout()">Logout</button>
</div>

<!-- Chat header -->
<div class="chat-header">Chat</div>

<!-- Messages -->
<div id="chatWrapper"></div>

<!-- Reply preview -->
<div id="chatInputWrapper">
  <div id="replyPreview" style="display:none;"><span id="replyText"></span><span id="cancelReply">✕</span></div>
  <input type="text" id="chatInput" placeholder="Type here..">
  <button id="sendBtn">➤</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyDmRrflu-Ysm6DyxV65SrMZ0AL7TP58mX4",
  authDomain: "login-34954.firebaseapp.com",
  projectId: "login-34954"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Elements */
const chatWrapper = document.getElementById("chatWrapper");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const replyPreview = document.getElementById("replyPreview");
const replyText = document.getElementById("replyText");
const cancelReply = document.getElementById("cancelReply");
let replyingTo = null;
let canSend = true;

/* User info */
let username="", pfp="";
const profileNameEl = document.getElementById("profileName");
const profilePicEl = document.getElementById("profilePic");

function stringToColor(str){
  let hash=0; for(let i=0;i<str.length;i++){ hash=str.charCodeAt(i)+((hash<<5)-hash);}
  let color='#'; for(let i=0;i<3;i++){ color+=('00'+((hash>>(i*8))&0xFF).toString(16)).slice(-2);}
  return color;
}

/* Auth & Firestore sync */
onAuthStateChanged(auth, async user=>{
  if(!user) location.replace("login.html");

  // Username
  const userSnap = await getDocs(query(collection(db,"usernames"),where("uid","==",user.uid)));
  username = !userSnap.empty ? userSnap.docs[0].id : user.email.split("@")[0];
  profileNameEl.textContent = username;

  // PFP
  const pfpDoc = await getDoc(doc(db,"userPFPs",user.uid));
  if(pfpDoc.exists() && pfpDoc.data().data){
    pfp = pfpDoc.data().data;
    profilePicEl.style.backgroundImage = `url(${pfp})`;
    profilePicEl.textContent="";
  } else {
    profilePicEl.style.backgroundImage="";
    profilePicEl.textContent = username.charAt(0).toUpperCase();
    profilePicEl.style.backgroundColor = stringToColor(username.toLowerCase());
  }

  loadMessages();
});

/* Menu logic */
const menuBtn = document.getElementById("menuBtn");
const closeMenu = document.getElementById("closeMenu");
menuBtn.onclick = () => document.body.classList.add("menu-open");
closeMenu.onclick = () => document.body.classList.remove("menu-open");
document.getElementById("tabDashboard").onclick = () => { document.body.classList.remove("menu-open"); setTimeout(()=> location.href="dashboard.html",350);}
document.getElementById("tabSettings").onclick = () => { document.body.classList.remove("menu-open"); setTimeout(()=> location.href="settings.html",350);}

/* Profile panel */
let panelOpen=false;
profilePicEl.addEventListener("click", ()=>{
  panelOpen=!panelOpen;
  document.getElementById("profilePanel").style.display=panelOpen?"flex":"none";
});
window.confirmLogout = ()=>{ if(confirm("Logout?")) auth.signOut().then(()=>location.href="login.html"); };

/* Send message */
sendBtn.onclick = async ()=>{
  const text = chatInput.value.trim();
  if(!text || !canSend) return;
  canSend=false;
  setTimeout(()=>canSend=true,2000);

  const msgData = {
    text,
    uid:auth.currentUser.uid,
    username,
    pfp,
    timestamp:new Date(),
    replyTo: replyingTo ? replyingTo.id : null,
    edited:false,
    deleted:false
  };
  await addDoc(collection(db,"messages"), msgData);
  chatInput.value="";
  replyingTo=null;
  replyPreview.style.display="none";
};

/* Cancel reply */
cancelReply.onclick = ()=>{ replyingTo=null; replyPreview.style.display="none"; };

/* Load & render messages */
function loadMessages(){
  const q = query(collection(db,"messages"), orderBy("timestamp"));
  onSnapshot(q, snapshot=>{
    chatWrapper.innerHTML="";
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      const owner = data.uid === auth.currentUser.uid;
      const msgEl = document.createElement("div");
      msgEl.className="message"+(owner?" owner":"");
      msgEl.dataset.id = docSnap.id;

      const pfpEl = document.createElement("div");
      pfpEl.className="pfp";
      if(data.pfp) pfpEl.style.backgroundImage=`url(${data.pfp})`;
      else { pfpEl.style.backgroundColor = stringToColor(data.username.toLowerCase()); pfpEl.textContent=data.username.charAt(0).toUpperCase();}
      
      const contentEl = document.createElement("div");
      contentEl.className="msgContent";

      if(data.replyTo){
        const replyData = snapshot.docs.find(d=>d.id===data.replyTo)?.data();
        if(replyData){
          const replyEl = document.createElement("div");
          replyEl.className="replyPreview";
          replyEl.textContent=`Replying to ${replyData.username}: ${replyData.text}`;
          contentEl.appendChild(replyEl);
        }
      }

      const unameEl = document.createElement("div");
      unameEl.className="username";
      unameEl.textContent=data.username;
      contentEl.appendChild(unameEl);

      const textEl = document.createElement("div");
      textEl.textContent = data.deleted ? `${data.username} deleted a message` : data.text;
      contentEl.appendChild(textEl);

      const timeEl = document.createElement("div");
      timeEl.className="time";
      timeEl.textContent = new Date(data.timestamp.seconds*1000).toLocaleTimeString('en-US',{timeZone:'America/New_York',hour:'2-digit',minute:'2-digit'});
      contentEl.appendChild(timeEl);

      if(data.edited) {
        const editedEl = document.createElement("div");
        editedEl.className="edited";
        editedEl.textContent="Edited";
        contentEl.appendChild(editedEl);
      }

      const actionsEl = document.createElement("div");
      actionsEl.className="actions";
      if(owner && !data.deleted){
        const editBtn = document.createElement("button");
        editBtn.textContent="Edit";
        editBtn.onclick = async ()=>{
          const newText = prompt("Edit message:", data.text);
          if(newText!==null) await updateDoc(doc(db,"messages",docSnap.id), {text:newText, edited:true});
        };
        const delBtn = document.createElement("button");
        delBtn.textContent="Delete";
        delBtn.onclick = async ()=>{
          await updateDoc(doc(db,"messages",docSnap.id), {deleted:true});
        };
        actionsEl.appendChild(editBtn);
        actionsEl.appendChild(delBtn);
      } else if(!owner && !data.deleted){
        const replyBtn = document.createElement("button");
        replyBtn.textContent="Reply";
        replyBtn.onclick = ()=>{
          replyingTo={id:docSnap.id,text:data.text,username:data.username};
          replyText.textContent=`Replying to ${data.username}: ${data.text}`;
          replyPreview.style.display="flex";
        };
        actionsEl.appendChild(replyBtn);
      }
      contentEl.appendChild(actionsEl);

      msgEl.appendChild(pfpEl);
      msgEl.appendChild(contentEl);
      chatWrapper.appendChild(msgEl);
      chatWrapper.scrollTop = chatWrapper.scrollHeight;
    });
  });
}
</script>

</body>
</html>