<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
body {
  margin:0;
  font-family:system-ui,sans-serif;
  background:#0b1e3d;
  color:white;
  display:flex;
  flex-direction:column;
  height:100vh;
}
#chatWrapper {
  flex:1;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.message {
  display:flex;
  gap:10px;
  align-items:flex-start;
}
.message .pfp {
  width:40px; height:40px;
  border-radius:50%;
  background-size:cover;
  background-position:center;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  color:white;
}
.message .content { display:flex; flex-direction:column; }
.username { font-weight:bold; }
.time { font-size:0.7rem; color:#ccc; }
#chatInputWrapper {
  display:flex;
}
#chatInput { flex:1; padding:10px; border:none; border-radius:5px; }
#sendBtn { padding:10px 15px; border:none; background:#4da3ff; color:black; cursor:pointer; }
</style>
</head>
<body>

<div id="chatWrapper"></div>

<div id="chatInputWrapper">
  <input id="chatInput" placeholder="Type here..">
  <button id="sendBtn">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyDmRrflu-Ysm6DyxV65SrMZ0AL7TP58mX4",
  authDomain: "login-34954.firebaseapp.com",
  projectId: "login-34954",
  storageBucket: "login-34954.firebasestorage.app",
  messagingSenderId: "422184727508",
  appId: "1:422184727508:web:cef39fc913d526febe9c41",
  measurementId: "G-1MMT3C4M7K"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let username = "User"; // fallback
const chatWrapper = document.getElementById("chatWrapper");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");

function stringToColor(str){
  let hash=0; for(let i=0;i<str.length;i++){ hash=str.charCodeAt(i)+((hash<<5)-hash);}
  let color='#'; for(let i=0;i<3;i++){ color+=('00'+((hash>>(i*8))&0xFF).toString(16)).slice(-2);}
  return color;
}

onAuthStateChanged(auth, user=>{
  if(!user) location.replace("login.html");
  username = user.displayName || user.email.split("@")[0];
});

/* Send message */
sendBtn.onclick = async () => {
  const text = chatInput.value.trim();
  if(!text) return;
  chatInput.value = "";
  try{
    await addDoc(collection(db,"messages"),{
      user: username,
      message: text,
      timestamp: serverTimestamp()
    });
  } catch(e){ console.error(e); }
};

/* Real-time messages */
const q = query(collection(db,"messages"), orderBy("timestamp"));
onSnapshot(q, snap=>{
  chatWrapper.innerHTML = "";
  snap.docs.forEach(d=>{
    const data = d.data();
    const msgDiv = document.createElement("div");
    msgDiv.className = "message";
    const pfpDiv = document.createElement("div");
    pfpDiv.className = "pfp";
    pfpDiv.textContent = data.user.charAt(0).toUpperCase();
    pfpDiv.style.backgroundColor = stringToColor(data.user.toLowerCase());
    const contentDiv = document.createElement("div");
    contentDiv.className = "content";
    const userDiv = document.createElement("div");
    userDiv.className = "username";
    userDiv.textContent = data.user;
    const textDiv = document.createElement("div");
    textDiv.textContent = data.message;
    const timeDiv = document.createElement("div");
    timeDiv.className = "time";
    if(data.timestamp) timeDiv.textContent = new Date(data.timestamp.seconds*1000).toLocaleTimeString();
    contentDiv.append(userDiv, textDiv, timeDiv);
    msgDiv.append(pfpDiv, contentDiv);
    chatWrapper.appendChild(msgDiv);
  });
  chatWrapper.scrollTop = chatWrapper.scrollHeight;
});
</script>

</body>
</html>