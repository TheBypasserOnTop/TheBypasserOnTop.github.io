<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Communicate</title>
<link rel="icon" href="favicon.ico">

<style>
body {
  margin:0;
  min-height:100vh;
  font-family:system-ui,sans-serif;
  background:radial-gradient(circle at top,#0b1e3d,#050b1a);
  color:#e6f0ff;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding-top:60px;
  overflow-x:hidden;
}

/* Chat island */
#chatIsland {
  width:95%;
  max-width:600px;
  background:rgba(12,25,55,.85);
  backdrop-filter:blur(16px);
  border-radius:20px;
  display:flex;
  flex-direction:column;
  height:80vh;
  overflow:hidden;
  box-shadow:0 15px 50px rgba(0,0,0,.5);
}

/* Chat header */
#chatHeader {
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px 20px;
  background:rgba(12,25,55,.9);
  backdrop-filter:blur(8px);
  border-bottom:1px solid rgba(255,255,255,.2);
  flex-shrink:0;
}

.userProfilePic {
  width:40px; height:40px;
  border-radius:50%;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  color:white;
  background-size:cover;
  background-position:center;
  flex-shrink:0;
}

.usernameLabel { font-weight:600; font-size:1rem; }

/* Messages area */
#chatMessages {
  flex:1;
  overflow-y:auto;
  padding:15px 20px;
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* Individual message */
.chatMessage {
  display:flex;
  align-items:flex-start;
  gap:10px;
}

.chatMessage .messageContent {
  background:rgba(12,25,55,.7);
  padding:10px 14px;
  border-radius:14px;
  max-width:75%;
  word-wrap:break-word;
  position:relative;
}

.messageContent .usernameLabel { font-weight:600; display:block; margin-bottom:3px; }
.messageContent .editedTag { font-size:0.7rem; opacity:0.6; margin-top:2px; }
.messageContent .replyBox {
  background:rgba(255,255,255,0.08);
  padding:5px 8px;
  border-left:2px solid #4da3ff;
  margin-bottom:5px;
  border-radius:8px;
  font-size:0.85rem;
  color:#cfd8f0;
}

/* Chat input */
#chatInputWrapper {
  display:flex;
  gap:10px;
  padding:10px 15px;
  background:rgba(12,25,55,.9);
  backdrop-filter:blur(8px);
  flex-shrink:0;
}
#chatInputWrapper input {
  flex:1;
  padding:12px;
  border-radius:12px;
  border:none;
  background:rgba(255,255,255,.08);
  color:white;
}
#chatInputWrapper button {
  padding:12px 20px;
  border-radius:12px;
  border:none;
  font-weight:600;
  cursor:pointer;
  background:#4da3ff;
  color:black;
}

/* Scrollbar */
#chatMessages::-webkit-scrollbar { width:6px; }
#chatMessages::-webkit-scrollbar-thumb { background:rgba(255,255,255,.2); border-radius:3px; }
</style>
</head>
<body>

<div id="chatIsland">
  <!-- Header -->
  <div id="chatHeader">
    <div class="userProfilePic"></div>
    <span class="usernameLabel"></span>
  </div>

  <!-- Messages -->
  <div id="chatMessages"></div>

  <!-- Input -->
  <div id="chatInputWrapper">
    <input placeholder="Type a message..." id="chatInput">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyDmRrflu-Ysm6DyxV65SrMZ0AL7TP58mX4",
  authDomain:"login-34954.firebaseapp.com",
  projectId:"login-34954"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const chatHeaderPic = document.querySelector("#chatHeader .userProfilePic");
const chatHeaderUsername = document.querySelector("#chatHeader .usernameLabel");
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");

function colorFrom(str){
  let h=0; for(let c of str) h=c.charCodeAt(0)+((h<<5)-h);
  return `hsl(${h%360},70%,50%)`;
}

// Auth + username/pfp
let currentUser = null;
let username = "";
let pfpURL = "";

onAuthStateChanged(auth, async user=>{
  if(!user) location.href="login.html";
  currentUser = user;

  // Get username
  const snap = await getDoc(doc(db,"usernames",user.uid));
  username = snap.exists()?snap.data().username: user.email.split("@")[0];

  // Get PFP
  const pfpDoc = await getDoc(doc(db,"userPFPs",user.uid));
  pfpURL = (pfpDoc.exists() && pfpDoc.data().data)? pfpDoc.data().data : "";

  // Header
  if(pfpURL){
    chatHeaderPic.style.backgroundImage = `url(${pfpURL})`;
    chatHeaderPic.textContent="";
  } else {
    chatHeaderPic.style.backgroundImage="";
    chatHeaderPic.textContent=username[0].toUpperCase();
    chatHeaderPic.style.backgroundColor=colorFrom(username);
  }
  chatHeaderUsername.textContent=username;

  // Listen to messages
  const q = query(collection(db,"messages"),orderBy("timestamp"));
  onSnapshot(q,snap=>{
    chatMessages.innerHTML="";
    snap.forEach(docSnap=>{
      const data = docSnap.data();
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("chatMessage");

      // PFP
      let msgPFP = data.pfp || "";
      let msgLetter = "";
      let bgColor = colorFrom(data.username);
      if(!msgPFP) msgLetter = data.username[0].toUpperCase();

      msgDiv.innerHTML = `
        <div class="userProfilePic" style="${msgPFP?`background-image:url(${msgPFP})`:`background-color:${bgColor};`}">
          ${msgLetter}
        </div>
        <div class="messageContent">
          <span class="usernameLabel">${data.username}</span>
          <div class="replyBox">${data.replyTo || ""}</div>
          <p>${data.text}</p>
          ${data.edited?"<span class='editedTag'>edited</span>":""}
        </div>
      `;
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  });
});

// Send message
sendBtn.onclick = async ()=>{
  const text = chatInput.value.trim();
  if(!text) return;
  await addDoc(collection(db,"messages"),{
    username: username,
    pfp: pfpURL,
    text: text,
    timestamp: new Date(),
    edited: false,
    replyTo: ""
  });
  chatInput.value="";
};
</script>
</body>
</html>